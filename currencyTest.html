
<html>
  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<style>
.max-width{
  width: 100%;
}
body {
  background: #191A20;
  color: white;
}
.table td, .table th, .table thead th {
  border: none;
}
table{
  border-collapse: unset;
}
#myChart {
  background: #EEEEEE;
  width: 100%;
}
.arrow-up {
  transform: rotate(-90deg);
    width: 35px;
}
.arrow-down {
  transform: rotate(90deg);
    width: 35px;
}
.tr_choose:hover {
      background: #b1b1b163;
      cursor: pointer;
}
</style>
  </head>
  <body>
    <div id="event-handling">

<div class="container mt-5">
  <div class="row">
    <div class="col-lg-4">
    <table class="table text-center">
    <thead>
      <div class="row mb-3">
          <h5 class="text-center">Панель котировок</h5>
      <tr>
        <th scope="col" @click="choose()">Валютные пары</th>
        <th scope="col" >Изменение(24h)</th>
        <th scope="col" >Цена</th>
      </tr>
    </thead>
    <tbody  >
      <tr class="tr_choose" @click="changeTable('BTC')">
        <td scope="row">USD | BTC</td>
        <td>{{ info.BTC.edit }} 
          <span v-if="info.BTC.edit>0"><img class="arrow-up" src="https://img.icons8.com/carbon-copy/100/26e07f/right.png"/></span> 
          <span v-else><img class="arrow-down" src="https://img.icons8.com/carbon-copy/100/fa314a/arrow.png"/></span> 
        </td>
        <td >{{ info.BTC.PRICE }}</td>
      </tr>
      <tr class="tr_choose" @click="changeTable('ETH')">
        <td scope="row" >USD | ETH</td>
        <td>{{ info.ETH.edit }} 
          <span v-if="info.ETH.edit>0"><img class="arrow-up" src="https://img.icons8.com/carbon-copy/100/26e07f/right.png"/></span> 
          <span v-else><img class="arrow-down" src="https://img.icons8.com/carbon-copy/100/fa314a/arrow.png"/></span> 
        </td>
        <td >{{ info.ETH.PRICE }}</td>
      </tr>
      <tr class="tr_choose" @click="changeTable('XRP')">
        <td scope="row">USD | XRP</td>
        <td>{{ info.XRP.edit }} 
          <span v-if="info.XRP.edit>0"><img class="arrow-up" src="https://img.icons8.com/carbon-copy/100/26e07f/right.png"/></span> 
          <span v-else><img class="arrow-down" src="https://img.icons8.com/carbon-copy/100/fa314a/arrow.png"/></span> 
        </td>
        <td >{{ info.XRP.PRICE }}</td>
      </tr>
    </tbody>
  </table>
    </div>
    <div class="col-lg-8">
      <canvas id="myChart" ></canvas>
    </div>
  </div>
</div>

</div>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="https://unpkg.com/vue@next"></script>
<script src="https://cdn.amcharts.com/lib/4/core.js"></script>
<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
<script src="https://cdn.amcharts.com/lib/4/themes/material.js"></script>
<script src="https://cdn.amcharts.com/lib/4/lang/de_DE.js"></script>
<script src="https://cdn.amcharts.com/lib/4/geodata/germanyLow.js"></script>
<script src="https://cdn.amcharts.com/lib/4/fonts/notosans-sc.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script >
      'use strict'

      const EventHandling = {
        data() {
          return {
            info: {
              BTC:{
                PRICE: 0,
                edit: 0
              },
              ETH:{
                PRICE: 0,
                edit: 0
              },
              XRP:{
                PRICE: 0,
                edit: 0
              }
            },
            linkFetch: '',
            fetchTime: [],
            fetchPrice: [],
            myChart: null
          }
        },

        methods: {
       
          changeTable: function (currencyChange){
            this.linkFetch = 'https://min-api.cryptocompare.com/data/v2/histominute?fsym='+currencyChange+'&tsym=USD&limit=10';

            fetch(this.linkFetch)
              .then((response) => {
                 return response.json();
              })
              .then(data => {
                for(let key in data.Data.Data){

                  let date = new Date(data.Data.Data[key].time * 1000);
                  let hours = date.getHours();
                  let minutes = "0" + date.getMinutes();
                  let formattedTime = hours + ':' + minutes.substr(-2);
                  this.fetchTime[key] =formattedTime;
                  this.fetchPrice[key] = data.Data.Data[key].close;

                }
                if(this.myChart){
                  this.myChart.destroy()
                }
                   var ctx = document.getElementById('myChart').getContext('2d');
                  this.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [...this.fetchTime],
                    datasets: [{
                        label: 'Цена',
                        data: [...this.fetchPrice],
                        borderColor: [
                            '#69b4d3'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
                  
            });



              
            },
      
          },

        created(){
          var apiKey = "fe33d40932b3fa6513b20ec42474d8a93920f03cf839d75a55bf16643df35a14";
          var ccStreamer= new WebSocket('wss://streamer.cryptocompare.com/v2?api_key=' + apiKey);
          ccStreamer.onopen =  () => {
            var subRequest = {
              "action": "SubAdd",
              "subs": ["2~Kraken~BTC~USD"]
            };
            var subRequest2 = {
              "action": "SubAdd",
              "subs": ["2~Kraken~ETH~USD"]
            };
            var subRequest3 = {
              "action": "SubAdd",
              "subs": ["2~Kraken~XRP~USD"]
            };
            ccStreamer.send(JSON.stringify(subRequest));
            ccStreamer.send(JSON.stringify(subRequest2));
            ccStreamer.send(JSON.stringify(subRequest3));
          }
            ccStreamer.onmessage = () => {
              let dat = JSON.parse(event.data);
              function current(cuu){
                cuu.PRICE = dat.PRICE;
                if(dat.OPEN24HOUR && dat.OPEN24HOUR<dat.PRICE){
                  cuu.edit = (dat.PRICE-dat.OPEN24HOUR)/dat.OPEN24HOUR*100;
                  cuu.edit = cuu.edit.toFixed(2)
                } else if (dat.OPEN24HOUR && dat.OPEN24HOUR>dat.PRICE){
                  cuu.edit = (dat.PRICE-dat.OPEN24HOUR)/dat.OPEN24HOUR*100;
                  cuu.edit = cuu.edit.toFixed(2)
                }
              }

              if(dat.PRICE && dat.FROMSYMBOL === 'BTC' ) {
                current(this.info.BTC)
              }   

              if(dat.PRICE && dat.FROMSYMBOL === 'ETH') {
                current(this.info.ETH)
              }

              if(dat.PRICE && dat.FROMSYMBOL === 'XRP') {
                current(this.info.XRP)
              } 
          }
        },

        mounted() {
           this.changeTable('BTC')
    },  




    computed: {
    
  }
}


      Vue.createApp(EventHandling).mount('#event-handling');

    </script>
    

  </body>
</html>
